# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

## –û–±—â–∞—è —Å—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   gw.ecomkassa.ru                           ‚îÇ
‚îÇ                   (–í–∞—à —Å–µ—Ä–≤–µ—Ä)                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     nginx (–ø–æ—Ä—Ç 80/443)                     ‚îÇ
‚îÇ                     SSL Termination                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ                       ‚îÇ
                ‚ñº                       ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   /api/*          ‚îÇ   ‚îÇ   /                   ‚îÇ
    ‚îÇ   –ü—Ä–æ–∫—Å–∏—Ä—É–µ—Ç—Å—è    ‚îÇ   ‚îÇ   –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã   ‚îÇ
    ‚îÇ   –Ω–∞ localhost    ‚îÇ   ‚îÇ   (React SPA)         ‚îÇ
    ‚îÇ   :3001           ‚îÇ   ‚îÇ   /dist               ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   Express.js Server               ‚îÇ
    ‚îÇ   (PM2 process manager)           ‚îÇ
    ‚îÇ                                   ‚îÇ
    ‚îÇ   Routes:                         ‚îÇ
    ‚îÇ   POST /api/Authorization/        ‚îÇ
    ‚îÇ        CreateAuthToken            ‚îÇ
    ‚îÇ   GET  /api/kkt/cloud/status      ‚îÇ
    ‚îÇ   POST /api/kkt/cloud/receipt     ‚îÇ
    ‚îÇ   GET  /health                    ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   PostgreSQL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)        ‚îÇ
    ‚îÇ   –¢–∞–±–ª–∏—Ü–∞: logs                   ‚îÇ
    ‚îÇ   –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤            ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (Postman/curl)
    ‚îÇ
    ‚îÇ POST /api/Authorization/CreateAuthToken
    ‚îÇ { login, password }
    ‚ñº
nginx (gw.ecomkassa.ru:443)
    ‚îÇ
    ‚îÇ –ü—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –Ω–∞ localhost:3001
    ‚ñº
Express.js Server
    ‚îÇ
    ‚îÇ –õ–æ–≥–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ PostgreSQL
    ‚îÇ
    ‚îÇ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç: login ‚Üí login
    ‚îÇ                password ‚Üí pass
    ‚ñº
eKomKassa API
(https://app.ecomkassa.ru/fiscalorder/v5/getToken)
    ‚îÇ
    ‚îÇ { token, group_code }
    ‚ñº
Express.js Server
    ‚îÇ
    ‚îÇ –õ–æ–≥–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –≤ PostgreSQL
    ‚ñº
nginx ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    ‚îÇ
    ‚îÇ { token, group_code }
    ‚úì
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ —á–µ–∫–∞ (Ferma —Ñ–æ—Ä–º–∞—Ç)

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    ‚îÇ
    ‚îÇ POST /api/kkt/cloud/receipt
    ‚îÇ { Request: { CustomerReceipt: {...} }, token }
    ‚ñº
nginx
    ‚îÇ
    ‚ñº
Express.js Server
    ‚îÇ
    ‚îÇ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç Ferma ‚Üí eKomKassa:
    ‚îÇ   - Items[] ‚Üí items[]
    ‚îÇ   - Vat ("Vat20") ‚Üí vat.type ("vat20")
    ‚îÇ   - TaxationSystem ("Common") ‚Üí sno ("osn")
    ‚îÇ   - PaymentMethod (4) ‚Üí payment_method ("full_payment")
    ‚îÇ   - Measure ("PIECE") ‚Üí measure (0)
    ‚îÇ
    ‚îÇ –§–æ—Ä–º–∏—Ä—É–µ—Ç payload –¥–ª—è eKomKassa
    ‚ñº
eKomKassa API
(https://app.ecomkassa.ru/fiscalorder/v5/700/sell)
    ‚îÇ
    ‚îÇ { uuid, status, ... }
    ‚ñº
Express.js Server
    ‚îÇ
    ‚îÇ –õ–æ–≥–∏—Ä—É–µ—Ç –≤ PostgreSQL
    ‚ñº
nginx ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    ‚îÇ
    ‚îÇ { uuid, status }
    ‚úì
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### Frontend (React SPA)

```
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/                    # shadcn/ui –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ button.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ card.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ input.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ gateway/               # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Gateway
‚îÇ       ‚îú‚îÄ‚îÄ AuthTab.tsx        # –í–∫–ª–∞–¥–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚îÇ       ‚îú‚îÄ‚îÄ StatusTab.tsx      # –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —á–µ–∫–∞
‚îÇ       ‚îú‚îÄ‚îÄ ReceiptTab.tsx     # –í–∫–ª–∞–¥–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–µ–∫–∞
‚îÇ       ‚îî‚îÄ‚îÄ TestResults.tsx    # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ Index.tsx              # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (—Ñ–æ—Ä–º–∞)
‚îÇ   ‚îú‚îÄ‚îÄ RequestLogs.tsx        # –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ª–æ–≥–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ NotFound.tsx           # 404 —Å—Ç—Ä–∞–Ω–∏—Ü–∞
‚îÇ
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts               # –£—Ç–∏–ª–∏—Ç—ã (cn, getApiUrl)
‚îÇ
‚îú‚îÄ‚îÄ App.tsx                    # React Router
‚îú‚îÄ‚îÄ main.tsx                   # Entry point
‚îî‚îÄ‚îÄ index.css                  # Tailwind CSS

dist/                          # Production build
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ index-[hash].js
‚îÇ   ‚îî‚îÄ‚îÄ index-[hash].css
‚îî‚îÄ‚îÄ ...
```

### Backend (Express.js Server)

```
server/
‚îú‚îÄ‚îÄ index.js                   # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ Express app setup
‚îÇ   ‚îú‚îÄ‚îÄ CORS middleware
‚îÇ   ‚îú‚îÄ‚îÄ POST /api/Authorization/CreateAuthToken
‚îÇ   ‚îú‚îÄ‚îÄ GET  /api/kkt/cloud/status
‚îÇ   ‚îú‚îÄ‚îÄ POST /api/kkt/cloud/receipt
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ convertFermaToEkomkassa()
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ convertSimpleFormat()
‚îÇ   ‚îú‚îÄ‚îÄ GET  /health
‚îÇ   ‚îî‚îÄ‚îÄ logToDB()
‚îÇ
‚îú‚îÄ‚îÄ package.json               # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ .env.example               # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ .env                       # –õ–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ .gitignore
‚îÇ
‚îú‚îÄ‚îÄ README.md                  # API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ DEPLOY.md                  # –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
‚îú‚îÄ‚îÄ QUICK-START.md             # –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
‚îú‚îÄ‚îÄ nginx-config-example.conf  # Nginx –∫–æ–Ω—Ñ–∏–≥
‚îî‚îÄ‚îÄ test-api.sh                # –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
```

### Database

```
db_migrations/
‚îî‚îÄ‚îÄ V1__init.sql               # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã logs

logs table:
‚îú‚îÄ‚îÄ id (SERIAL PRIMARY KEY)
‚îú‚îÄ‚îÄ function_name (VARCHAR)    # 'auth', 'status', 'receipt'
‚îú‚îÄ‚îÄ log_level (VARCHAR)        # 'INFO', 'ERROR'
‚îú‚îÄ‚îÄ message (TEXT)
‚îú‚îÄ‚îÄ request_data (TEXT)        # JSON
‚îú‚îÄ‚îÄ response_data (TEXT)       # JSON
‚îú‚îÄ‚îÄ request_id (VARCHAR)
‚îú‚îÄ‚îÄ duration_ms (INTEGER)
‚îú‚îÄ‚îÄ status_code (INTEGER)
‚îî‚îÄ‚îÄ timestamp (TIMESTAMP)
```

---

## –ú–∞–ø–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö (Ferma ‚Üí eKomKassa)

### –¢–∏–ø—ã –ù–î–°

| Ferma           | eKomKassa |
|-----------------|-----------|
| VatNo           | none      |
| Vat0            | vat0      |
| Vat10           | vat10     |
| Vat20           | vat20     |
| CalculatedVat10110 | vat10  |
| CalculatedVat20120 | vat20  |

### –°–∏—Å—Ç–µ–º–∞ –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è

| Ferma                    | eKomKassa       |
|--------------------------|-----------------|
| Common                   | osn             |
| Simplified               | usn_income      |
| SimplifiedWithExpenses   | usn_income_outcome |
| Unified                  | envd            |
| Patent                   | patent          |
| UnifiedAgricultural      | esn             |

### –ü—Ä–∏–∑–Ω–∞–∫ —Å–ø–æ—Å–æ–±–∞ —Ä–∞—Å—á—ë—Ç–∞

| Ferma (—á–∏—Å–ª–æ) | eKomKassa          |
|---------------|--------------------|
| 0             | full_prepayment    |
| 1             | prepayment         |
| 2             | advance            |
| 3             | full_payment       |
| 4             | partial_payment    |
| 5             | credit             |
| 6             | credit_payment     |

### –ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è

| Ferma                | eKomKassa (—á–∏—Å–ª–æ) |
|----------------------|-------------------|
| PIECE                | 0                 |
| GRAM                 | 10                |
| KILOGRAM             | 11                |
| METER                | 22                |
| LITER                | 41                |
| KILOWATT_HOUR        | 50                |
| DAY                  | 70                |
| HOUR                 | 71                |
| OTHER                | 255               |

### –¢–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π

| Ferma                      | eKomKassa               |
|----------------------------|-------------------------|
| Income                     | sell                    |
| IncomeReturn               | sell_refund             |
| Outcome                    | buy                     |
| OutcomeReturn              | buy_refund              |
| IncomeCorrection           | sell_correction         |
| OutcomeCorrection          | buy_correction          |

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. SSL/TLS

```
Let's Encrypt (Certbot)
    ‚Üì
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 90 –¥–Ω–µ–π
    ‚Üì
nginx —Å SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
    ‚Üì
TLS 1.2 / 1.3 —Ç–æ–ª—å–∫–æ
```

### 2. –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```nginx
X-Frame-Options: SAMEORIGIN
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
```

### 3. –ò–∑–æ–ª—è—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

```
PM2 –∑–∞–ø—É—Å–∫–∞–µ—Ç Node.js –ø—Ä–æ—Ü–µ—Å—Å
    ‚Üì
–†–∞–±–æ—Ç–∞–µ—Ç –æ—Ç –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    ‚Üì
–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ localhost:3001
    ‚Üì
nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ /api/* paths
```

### 4. –õ–æ–≥–∏

```
PostgreSQL logs table
    ‚Üì
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤
    ‚Üì
–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫
    ‚Üì
Request ID –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞
```

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### Nginx

- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏**: 1 –≥–æ–¥ –¥–ª—è JS/CSS/images
- **gzip —Å–∂–∞—Ç–∏–µ**: –≤–∫–ª—é—á–µ–Ω–æ
- **HTTP/2**: –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è

### Express.js

- **PM2 cluster mode**: –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
- **–¢–∞–π–º–∞—É—Ç—ã**: 60 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–ø—Ä–æ—Å
- **Keep-Alive**: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è

### PostgreSQL

- **Connection pooling**: —á–µ—Ä–µ–∑ pg.Pool
- **–ò–Ω–¥–µ–∫—Å—ã**: –Ω–∞ request_id, timestamp
- **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**: –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# PM2 —Å—Ç–∞—Ç—É—Å
pm2 status

# –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
pm2 logs ekomkassa-gateway

# –†–µ—Å—É—Ä—Å—ã
pm2 monit

# Nginx —Å—Ç–∞—Ç—É—Å
systemctl status nginx

# –õ–æ–≥–∏ nginx
tail -f /var/log/nginx/gw.ecomkassa.ru-access.log
tail -f /var/log/nginx/gw.ecomkassa.ru-error.log
```

---

## –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

```bash
# –ë—ç–∫–∞–ø
pg_dump ekomkassa_gateway > backup_$(date +%Y%m%d).sql

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
psql ekomkassa_gateway < backup_20241015.sql
```

### –ö–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞

```bash
# –ß–µ—Ä–µ–∑ Git
git pull  # –í—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç

# –†—É—á–Ω–æ–π –±—ç–∫–∞–ø
tar -czf backup_$(date +%Y%m%d).tar.gz /var/www/ekomkassa-gateway/
```

---

## –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ (–±–æ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞)

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ —á–µ—Ä–µ–∑ PM2
pm2 start index.js -i 4 --name ekomkassa-gateway

# PM2 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç –Ω–∞–≥—Ä—É–∑–∫—É
```

### –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–æ–≤)

```
Load Balancer (nginx)
    ‚Üì
    ‚îú‚îÄ‚îÄ Server 1 (gw1.ecomkassa.ru)
    ‚îú‚îÄ‚îÄ Server 2 (gw2.ecomkassa.ru)
    ‚îî‚îÄ‚îÄ Server 3 (gw3.ecomkassa.ru)
         ‚Üì
Shared PostgreSQL
```

---

–í–æ–ø—Ä–æ—Å—ã? –°–º–æ—Ç—Ä–∏—Ç–µ [DEPLOY.md](./server/DEPLOY.md) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π! üöÄ
