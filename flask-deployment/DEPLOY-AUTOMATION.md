# üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–µ–ø–ª–æ—è EcomKassa Gateway

–î–≤–∞ —Å–ø–æ—Å–æ–±–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞:

## –°–ø–æ—Å–æ–± 1: –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π (–±—ã—Å—Ç—Ä–æ –∏ –ø—Ä–æ—Å—Ç–æ)

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–∏ –æ–¥–∏–Ω —Ä–∞–∑:
cd /var/www/ekomkassa-gateway/flask-deployment
chmod +x deploy.sh
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

```bash
# –ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç:
sudo ./deploy.sh
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
- ‚úÖ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–µ—Ä–≤–∏—Å
- ‚úÖ –ó–∞–±–∏—Ä–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
- ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞—Ç–Ω–æ
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## –°–ø–æ—Å–æ–± 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ GitHub Webhook (–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)

–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è** –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ GitHub!

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞:

```bash
# 1. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–∏:
cd /var/www/ekomkassa-gateway/flask-deployment
chmod +x setup-webhook.sh deploy.sh
sudo ./setup-webhook.sh
```

–°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—Å—Ç webhook-—Å–µ—Ä–≤–µ—Ä –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –æ—Ç GitHub.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub:

```bash
# 2. –£–∑–Ω–∞–π IP —Å–µ—Ä–≤–µ—Ä–∞:
curl ifconfig.me
```

**3. –û—Ç–∫—Ä–æ–π GitHub ‚Üí —Ç–≤–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ‚Üí Settings ‚Üí Webhooks ‚Üí Add webhook**

–ó–∞–ø–æ–ª–Ω–∏:
- **Payload URL:** `http://–í–ê–®_IP:9000/webhook`
- **Content type:** `application/json`
- **Which events:** Just the push event
- **Active:** ‚úÖ –≥–∞–ª–æ—á–∫–∞

**4. –°–æ—Ö—Ä–∞–Ω–∏ webhook**

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç—É—Å webhook-—Å–µ—Ä–≤–µ—Ä–∞:
sudo systemctl status github-webhook

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:
sudo journalctl -u github-webhook -f
```

–¢–µ–ø–µ—Ä—å —Å–¥–µ–ª–∞–π `git push` ‚Äî –∏ —Å–µ—Ä–≤–µ—Ä –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! üéâ

---

## –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

–ß—Ç–æ–±—ã —Ç–æ–ª—å–∫–æ GitHub –º–æ–≥ –∑–∞–ø—É—Å–∫–∞—Ç—å –¥–µ–ø–ª–æ–π:

```bash
# 1. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–µ–∫—Ä–µ—Ç:
openssl rand -hex 20

# 2. –°–∫–æ–ø–∏—Ä—É–π —Å–µ–∫—Ä–µ—Ç

# 3. –î–æ–±–∞–≤—å –≤ GitHub webhook:
# Settings ‚Üí Webhooks ‚Üí Edit ‚Üí Secret ‚Üí –≤—Å—Ç–∞–≤—å —Å–µ–∫—Ä–µ—Ç ‚Üí Update webhook

# 4. –î–æ–±–∞–≤—å —Å–µ–∫—Ä–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä:
sudo systemctl edit github-webhook

# –î–æ–±–∞–≤—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É (–∑–∞–º–µ–Ω–∏ YOUR_SECRET):
# [Service]
# Environment="GITHUB_WEBHOOK_SECRET=YOUR_SECRET"

# 5. –°–æ—Ö—Ä–∞–Ω–∏ (Ctrl+X ‚Üí Y ‚Üí Enter)

# 6. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏:
sudo systemctl restart github-webhook
```

---

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –î–µ–ø–ª–æ–π —Å–∫—Ä–∏–ø—Ç:
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–ø–ª–æ–π –≤—Ä—É—á–Ω—É—é
sudo /var/www/ekomkassa-gateway/flask-deployment/deploy.sh

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
sudo journalctl -u ekomkassa-gateway -n 50 -f
```

### Webhook —Å–µ—Ä–≤–µ—Ä:
```bash
# –°—Ç–∞—Ç—É—Å
sudo systemctl status github-webhook

# –õ–æ–≥–∏
sudo journalctl -u github-webhook -f

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
sudo systemctl restart github-webhook

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
sudo systemctl stop github-webhook

# –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
sudo systemctl disable github-webhook
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
flask-deployment/
‚îú‚îÄ‚îÄ deploy.sh              # –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –æ–±–æ–∏—Ö —Å–ø–æ—Å–æ–±–æ–≤)
‚îú‚îÄ‚îÄ setup-webhook.sh       # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook —Å–µ—Ä–≤–µ—Ä–∞
‚îî‚îÄ‚îÄ DEPLOY-AUTOMATION.md   # –≠—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

/var/www/webhook/          # –°–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ webhook
‚îî‚îÄ‚îÄ webhook-server.py      # –°–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–∏—ë–º–∞ —Å–æ–±—ã—Ç–∏–π –æ—Ç GitHub
```

---

## Troubleshooting

### Webhook –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω:
sudo systemctl status github-webhook

# 2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –ø–æ—Ä—Ç 9000 –æ—Ç–∫—Ä—ã—Ç:
sudo netstat -tlnp | grep 9000

# 3. –ü—Ä–æ–≤–µ—Ä—å —Ñ–∞–π—Ä–≤–æ–ª:
sudo ufw status
sudo ufw allow 9000/tcp

# 4. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏:
sudo journalctl -u github-webhook -n 100
```

### –î–µ–ø–ª–æ–π –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π:

```bash
# –ó–∞–ø—É—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç –≤—Ä—É—á–Ω—É—é —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫—É:
cd /var/www/ekomkassa-gateway/flask-deployment
sudo bash -x ./deploy.sh
```

### GitHub webhook –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É:

–ü—Ä–æ–≤–µ—Ä—å –≤ GitHub: Settings ‚Üí Webhooks ‚Üí Recent Deliveries  
–¢–∞–º –≤–∏–¥–Ω–æ –∫–∞–∫–æ–π –æ—Ç–≤–µ—Ç –≤–µ—Ä–Ω—É–ª —Å–µ—Ä–≤–µ—Ä.

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
- –ò—Å–ø–æ–ª—å–∑—É–π —Å–µ–∫—Ä–µ—Ç –¥–ª—è webhook (—Å–º. –≤—ã—à–µ)
- –ó–∞–∫—Ä–æ–π –ø–æ—Ä—Ç 9000 –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ Nginx proxy
- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π –ª–æ–≥–∏: `sudo journalctl -u github-webhook`

### üîí Proxy —á–µ—Ä–µ–∑ Nginx (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

–ï—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—à—å –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ø–æ—Ä—Ç 9000:

```nginx
# /etc/nginx/sites-available/gw.ecomkassa.ru

server {
    listen 80;
    server_name gw.ecomkassa.ru;
    
    # ... –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ...
    
    location /webhook {
        proxy_pass http://127.0.0.1:9000/webhook;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

–¢–æ–≥–¥–∞ –≤ GitHub webhook –∏—Å–ø–æ–ª—å–∑—É–π: `http://gw.ecomkassa.ru/webhook`

---

## –û—Ç–∫–∞—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

```bash
# –û—Ç–∫–∞—Ç–∏—Ç—å—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç:
cd /var/www/ekomkassa-gateway
git log --oneline -n 10  # –í—ã–±–µ—Ä–∏ –∫–æ–º–º–∏—Ç
sudo git reset --hard COMMIT_HASH
sudo systemctl restart ekomkassa-gateway
```

---

–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –¥–µ–ø–ª–æ–π ‚Äî —ç—Ç–æ –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –∏–ª–∏ –≤–æ–æ–±—â–µ –∞–≤—Ç–æ–º–∞—Ç üöÄ
